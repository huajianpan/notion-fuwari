---
// 语言切换器组件
import { Icon } from "astro-icon/components";
import { locales, localeNames, type Locale } from "../../i18n";
---

<div class="relative" id="lang-switcher">
	<button
		id="lang-btn"
		class="btn-plain h-11 w-11 rounded-lg active:scale-90 flex items-center justify-center"
		aria-label="Switch Language"
	>
		<Icon name="material-symbols:translate" class="text-[1.25rem]" />
	</button>

	<div
		id="lang-menu"
		class="hidden absolute right-0 top-full mt-2 py-2 w-32 rounded-lg bg-[var(--card-bg)] shadow-lg border border-[var(--line-divider)] z-50"
	>
		<!-- 语言选项将通过 JavaScript 动态生成 -->
	</div>
</div>

<script is:inline>
	// 语言配置（内联定义）
	const locales = ['zh-CN', 'en'];
	const localeNames = {
		'zh-CN': '简体中文',
		'en': 'English'
	};

	function initLangSwitcher() {
		// 获取当前语言偏好
		const getCurrentLocale = () => {
			if (typeof localStorage !== 'undefined') {
				const preferredLocale = localStorage.getItem('preferred-locale');
				if (preferredLocale && locales.includes(preferredLocale)) {
					return preferredLocale;
				}
			}
			return 'zh-CN'; // 默认语言
		};

		const currentLocale = getCurrentLocale();

		const btn = document.getElementById('lang-btn');
		const menu = document.getElementById('lang-menu');

		if (!btn || !menu) return;

		// 动态渲染语言选项
		menu.innerHTML = locales.map((locale) => `
			<button
				class="lang-option w-full px-4 py-2 text-left text-sm hover:bg-[var(--btn-plain-bg-hover)] transition ${locale === currentLocale ? 'text-[var(--primary)] font-medium' : ''}"
				data-locale="${locale}"
			>
				${localeNames[locale]}
			</button>
		`).join('');

		// 切换菜单显示
		btn.addEventListener('click', (e) => {
			e.stopPropagation();
			menu.classList.toggle('hidden');
		});

		// 点击外部关闭菜单
		document.addEventListener('click', () => {
			menu.classList.add('hidden');
		});

		// 防止菜单内点击关闭
		menu.addEventListener('click', (e) => {
			e.stopPropagation();
		});

		// 语言选择
		const options = document.querySelectorAll('.lang-option');
		options.forEach((option) => {
			option.addEventListener('click', () => {
				const locale = option.dataset.locale;
				if (!locale) return;

				// 保存语言偏好
				localStorage.setItem('preferred-locale', locale);

				// 获取当前路径
				const currentPath = window.location.pathname;

				// 转换路径
				let newPath = currentPath;

				if (locale === 'zh-CN') {
					// 切换到中文：移除语言前缀
					newPath = currentPath.replace(/\/posts\/en\//, '/posts/');
				} else {
					// 切换到其他语言
					if (currentPath.includes('/posts/') && !currentPath.includes('/posts/en/')) {
						newPath = currentPath.replace('/posts/', `/posts/${locale}/`);
					} else if (currentPath.includes('/posts/en/')) {
						newPath = currentPath.replace('/posts/en/', `/posts/${locale}/`);
					}
				}

				// 如果路径没变，刷新页面
				if (newPath !== currentPath) {
					window.location.href = newPath;
				} else {
					window.location.reload();
				}

				menu.classList.add('hidden');
			});
		});
	}

	// 初始化
	initLangSwitcher();

	// Astro View Transitions 支持
	document.addEventListener('astro:after-swap', initLangSwitcher);
</script>

<style>
	#lang-menu {
		animation: fadeIn 0.15s ease-out;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(-8px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>
